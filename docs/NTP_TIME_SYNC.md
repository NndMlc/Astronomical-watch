# NTP Time Synchronization

## –ü—Ä–µ–≥–ª–µ–¥

Astronomical Watch –ø–æ–¥—Ä–∂–∞–≤–∞ **–∞—É—Ç–æ–º–∞—Ç—Å–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò—É –≤—Ä–µ–º–µ–Ω–∞ –ø—Ä–µ–∫–æ NTP-–∞** (Network Time Protocol) –∑–∞ –º–∞–∫—Å–∏–º–∞–ª–Ω—É –ø—Ä–µ—Ü–∏–∑–Ω–æ—Å—Ç –∞—Å—Ç—Ä–æ–Ω–æ–º—Å–∫–æ–≥ –≤—Ä–µ–º–µ–Ω–∞. –û–≤–æ —ò–µ –ø–æ—Å–µ–±–Ω–æ –≤–∞–∂–Ω–æ —ò–µ—Ä –∞—Å—Ç—Ä–æ–Ω–æ–º—Å–∫–µ –∫–∞–ªkul–∞—Ü–∏—ò–µ –∑–∞—Ö—Ç–µ–≤–∞—ò—É –ø—Ä–µ—Ü–∏–∑–Ω–æ –≤—Ä–µ–º–µ.

## –ö–∞–∫–æ —Ä–∞–¥–∏

### –ê—É—Ç–æ–º–∞—Ç—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞

–ö–∞–¥–∞ –ø–æ–∫—Ä–µ–Ω–µ—Ç–µ –∞–ø–ª–∏–∫–∞—Ü–∏—ò—É, NTP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞ —Å–µ –∞—É—Ç–æ–º–∞—Ç—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–∞:

1. **–ò–Ω–∏—Ü–∏—ò–∞–ª–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞** - –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—É –∞–ø–ª–∏–∫–∞—Ü–∏—ò–µ
2. **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞** - —Å–≤–∞–∫–∏—Ö 60 –º–∏–Ω—É—Ç–∞ (–ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–Ω–æ)
3. **–ü—Ä–µ—Ü–∏–∑–Ω–æ—Å—Ç** - —Ç–∏–ø–∏—á–Ω–æ ¬±5-50ms, —É –∑–∞–≤–∏—Å–Ω–æ—Å—Ç–∏ –æ–¥ –º—Ä–µ–∂–µ

### NTP —Å–µ—Ä–≤–µ—Ä–∏

–ü–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–Ω–∏ NTP —Å–µ—Ä–≤–µ—Ä: **pool.ntp.org** (–≥–ª–æ–±–∞–ª–Ω–∏ –ø—É–ª NTP —Å–µ—Ä–≤–µ—Ä–∞)

### –ö–æ–º–ø–∞—Ç–∏–±–∏–ª–Ω–æ—Å—Ç

- ‚úÖ **Linux** - –ü—É–Ω–∞ –ø–æ–¥—Ä—à–∫–∞
- ‚úÖ **Windows** - –ü—É–Ω–∞ –ø–æ–¥—Ä—à–∫–∞  
- ‚úÖ **macOS** - –ü—É–Ω–∞ –ø–æ–¥—Ä—à–∫–∞
- ‚ö†Ô∏è  **Offline —Ä–µ–∂–∏–º** - –ö–æ—Ä–∏—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—Å–∫–æ –≤—Ä–µ–º–µ –∞–∫–æ –Ω–µ–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

## –ö–∞–∫–æ –∫–æ—Ä–∏—Å—Ç–∏—Ç–∏

### –û—Å–Ω–æ–≤–Ω–∞ —É–ø–æ—Ç—Ä–µ–±–∞ (–∞—É—Ç–æ–º–∞—Ç—Å–∫–∏)

–ê–ø–ª–∏–∫–∞—Ü–∏—ò–∞ –∞—É—Ç–æ–º–∞—Ç—Å–∫–∏ –∫–æ—Ä–∏—Å—Ç–∏ NTP –≤—Ä–µ–º–µ –∫–∞–¥–∞ —ò–µ –¥–æ—Å—Ç—É–ø–Ω–æ:

```python
from astronomical_watch.ui.main import AstronomicalWatchApp

# NTP sync —ò–µ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–Ω–æ —É–∫—ô—É—á–µ–Ω
app = AstronomicalWatchApp(enable_ntp_sync=True)
app.show_widget()
```

### –ò—Å–∫—ô—É—á–∏–≤–∞—ö–µ NTP-–∞

–ê–∫–æ –Ω–µ –∂–µ–ª–∏—Ç–µ NTP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò—É:

```python
app = AstronomicalWatchApp(enable_ntp_sync=False)
```

### –†—É—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞

```python
from astronomical_watch.net.time_sync import update_time_sync, get_sync_status

# –§–æ—Ä—Å–∏—Ä–∞—ò —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò—É
if update_time_sync(force=True):
    status = get_sync_status()
    print(f"Offset: {status['offset_ms']:.1f}ms")
```

### –ü—Ä–æ–≤–µ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–µ

```python
from astronomical_watch.net.time_sync import get_sync_status

status = get_sync_status()
if status['synced']:
    print(f"–í—Ä–µ–º–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–æ–≤–∞–Ω–æ")
    print(f"–û—Ñ—Å–µ—Ç: {status['offset_ms']:.1f}ms")
    print(f"–ü–æ—Å–ª–µ–¥—öa —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞: {status['last_sync']}")
    print(f"–ü—Ä–µ: {status['age_seconds']/60:.1f} –º–∏–Ω—É—Ç–∞")
else:
    print("–í—Ä–µ–º–µ –Ω–∏—ò–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–æ–≤–∞–Ω–æ (–∫–æ—Ä–∏—Å—Ç–∏ —Å–µ —Å–∏—Å—Ç–µ–º—Å–∫–æ –≤—Ä–µ–º–µ)")
```

### –î–æ–±–∏—ò–∞—ö–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–æ–≤–∞–Ω–æ–≥ –≤—Ä–µ–º–µ–Ω–∞

```python
from astronomical_watch.net.time_sync import now_utc

# –ö–æ—Ä–∏—Å—Ç–∏ NTP –∞–∫–æ —ò–µ –¥–æ—Å—Ç—É–ø–∞–Ω, –∏–Ω–∞—á–µ —Å–∏—Å—Ç–µ–º—Å–∫–æ –≤—Ä–µ–º–µ
current_time = now_utc(use_ntp=True)

# –£–≤–µ–∫ –∫–æ—Ä–∏—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—Å–∫–æ –≤—Ä–µ–º–µ
system_time = now_utc(use_ntp=False)
```

## –ü—Ä–µ–¥–Ω–æ—Å—Ç–∏ NTP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–µ

### –ë–µ–∑ NTP-–∞ (—Å–∏—Å—Ç–µ–º—Å–∫–æ –≤—Ä–µ–º–µ)
- üïê –ó–∞–≤–∏—Å–∏ –æ–¥ –ø—Ä–µ—Ü–∏–∑–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—Å–∫–æ–≥ —Å–∞—Ç–∞
- ‚ö†Ô∏è  –ú–æ–∂–µ –±–∏—Ç–∏ ¬±1-30 —Å–µ–∫—É–Ω–¥–∏ –ø–æ–≥—Ä–µ—à–Ω–æ
- üìâ –í—Ä–µ–º–µ–Ω—Å–∫–∏ drift (–æ–¥—Å—Ç—É–ø–∞—ö–µ) —Ç–æ–∫–æ–º —Ä–∞–¥–∞

### –°–∞ NTP-–æ–º
- ‚úÖ –¢–∏–ø–∏—á–Ω–∞ –ø—Ä–µ—Ü–∏–∑–Ω–æ—Å—Ç: **¬±5-50ms**
- üåê –ê—É—Ç–æ–º–∞—Ç—Å–∫–∞ –∫–æ—Ä–µ–∫—Ü–∏—ò–∞ –≤—Ä–µ–º–µ–Ω—Å–∫–æ–≥ offset-–∞
- üîÑ –ü–µ—Ä–∏–æ–¥–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞
- üìä –ö–æ–º–ø–µ–Ω–∑–∞—Ü–∏—ò–∞ –∑–∞ –º—Ä–µ–∂–Ω—É –ª–∞—Ç–µ–Ω—Ü–∏—ò—É

## –ü—Ä–µ—Ü–∏–∑–Ω–æ—Å—Ç –∞—Å—Ç—Ä–æ–Ω–æ–º—Å–∫–æ–≥ –≤—Ä–µ–º–µ–Ω–∞

–ó–∞ **Astronomical Watch**, –ø—Ä–µ—Ü–∏–∑–Ω–æ—Å—Ç —ò–µ –∫—Ä–∏—Ç–∏—á–Ω–∞:

- **1 miliDies = 86.4 —Å–µ–∫—É–Ω–¥–∏**
- **–ü–æ–≥—Ä–µ—à–∫–∞ –æ–¥ 10 —Å–µ–∫—É–Ω–¥–∏** ‚âà 0.12 miliDies –ø–æ–≥—Ä–µ—à–∫–µ
- **NTP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞** –æ–±–µ–∑–±–µ—í—É—ò–µ —Ç–∞—á–Ω–æ—Å—Ç –¥–æ **<0.001 miliDies**

### –ü—Ä–∏–º–µ—Ä —É—Ç–∏—Ü–∞—ò–∞

| –í—Ä–µ–º–µ–Ω—Å–∫–∞ –≥—Ä–µ—à–∫–∞ | –£—Ç–∏—Ü–∞—ò –Ω–∞ Astronomical Time |
|------------------|------------------------------|
| ¬±1 —Å–µ–∫—É–Ω–¥–∞       | ¬±0.012 miliDies              |
| ¬±10 —Å–µ–∫—É–Ω–¥–∏      | ¬±0.12 miliDies               |
| ¬±1 –º–∏–Ω—É—Ç         | ¬±0.69 miliDies               |
| **NTP sync (¬±50ms)** | **¬±0.0006 miliDies** ‚úÖ     |

## –¢–µ—Ö–Ω–∏—á–∫–∞ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—ò–∞

### –ú–æ–¥—É–ª: `astronomical_watch.net.time_sync`

–ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞ NTP –∫–ª–∏—ò–µ–Ω—Ç —Å–∞:
- UDP —Å–æ–∫–µ—Ç –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—ò–∞ (–ø–æ—Ä—Ç 123)
- NTP packet format (RFC 5905)
- Round-trip time compensation
- Thread-safe –∫–µ—à–∏—Ä–∞—ö–µ –æ—Ñ—Å–µ—Ç–∞
- –ê—É—Ç–æ–º–∞—Ç—Å–∫–∏ retry –º–µ—Ö–∞–Ω–∏–∑–∞–º

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—ò–∞ —É UI

–°–≤–∏ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –∫–æ—Ä–∏—Å—Ç–µ `_get_current_utc_time()` helper —Ñ—É–Ω–∫—Ü–∏—ò—É –∫–æ—ò–∞:
1. –ü–æ–∫—É—à–∞–≤–∞ –¥–∞ –∫–æ—Ä–∏—Å—Ç–∏ NTP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–æ–≤–∞–Ω–æ –≤—Ä–µ–º–µ
2. –í—Ä–∞—õ–∞ —Å–∏—Å—Ç–µ–º—Å–∫–æ –≤—Ä–µ–º–µ –∞–∫–æ NTP –Ω–∏—ò–µ –¥–æ—Å—Ç—É–ø–∞–Ω
3. Graceful fallback –±–µ–∑ –≥—Ä–µ—à–∞–∫–∞

## Debugging

### –ü—Ä–æ–≤–µ—Ä–∞ –¥–∞ –ª–∏ —Ä–∞–¥–∏ NTP sync

```bash
# –ü–æ–∫—Ä–µ–Ω–∏ –∞–ø–ª–∏–∫–∞—Ü–∏—ò—É —Å–∞ verbose output-–æ–º
python astronomical_watch_desktop.py

# –û—á–µ–∫–∏–≤–∞–Ω–∏ output:
# üïê Initializing NTP time synchronization...
# ‚úÖ NTP sync successful: offset = -3.5ms
# üïê Started periodic NTP sync (interval: 60 min)
```

### –¢–µ—Å—Ç–∏—Ä–∞—ö–µ NTP —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç–∏

```bash
# –ü–æ–∫—Ä–µ–Ω–∏ NTP —Ç–µ—Å—Ç–æ–≤–µ
python -m pytest tests/test_ntp_sync.py -v

# –†—É—á–Ω–∏ —Ç–µ—Å—Ç
python -c "from astronomical_watch.net.time_sync import *; \
           update_time_sync(force=True); \
           print(get_sync_status())"
```

## –†–µ—à–∞–≤–∞—ö–µ –ø—Ä–æ–±–ª–µ–º–∞

### NTP sync –Ω–µ—É—Å–ø–µ—à–∞–Ω

**–£–∑—Ä–æ—Ü–∏:**
- –ù–µ–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤–µ–∑–µ
- Firewall –±–ª–æ–∫–∏—Ä–∞ UDP –ø–æ—Ä—Ç 123
- NTP —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–∞–Ω

**–†–µ—à–µ—ö–µ:**
- –ê–ø–ª–∏–∫–∞—Ü–∏—ò–∞ –Ω–∞—Å—Ç–∞–≤—ô–∞ —Å–∞ —Å–∏—Å—Ç–µ–º—Å–∫–∏–º –≤—Ä–µ–º–µ–Ω–æ–º
- –ü–µ—Ä–∏–æ–¥–∏—á–Ω–∏ retry –∞—É—Ç–æ–º–∞—Ç—Å–∫–∏

### –í–µ–ª–∏–∫–∏ –≤—Ä–µ–º–µ–Ω—Å–∫–∏ offset

–ê–∫–æ –¥–æ–±–∏—ò–µ—Ç–µ —É–ø–æ–∑–æ—Ä–µ—ö–µ –æ –≤–µ–ª–∏–∫–æ–º –æ—Ñ—Å–µ—Ç—É (>1s):

```
‚ö†Ô∏è  System clock offset: 1250ms (consider syncing system time)
```

**–ü—Ä–µ–ø–æ—Ä—É–∫–µ:**
1. **Linux:** `sudo ntpdate pool.ntp.org` –∏–ª–∏ `sudo systemctl restart systemd-timesyncd`
2. **Windows:** Settings ‚Üí Time & Language ‚Üí Sync now
3. **macOS:** System Preferences ‚Üí Date & Time ‚Üí Set date and time automatically

## –ë–µ–∑–±–µ–¥–Ω–æ—Å—Ç –∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç

- NTP –ø—Ä–æ—Ç–æ–∫–æ–ª —ò–µ **read-only** (—Å–∞–º–æ —á–∏—Ç–∞ –≤—Ä–µ–º–µ)
- –ù–µ —à–∞—ô–µ –Ω–∏–∫–∞–∫–≤–µ –ª–∏—á–Ω–µ –ø–æ–¥–∞—Ç–∫–µ
- –ö–æ—Ä–∏—Å—Ç–∏ —ò–∞–≤–Ω–µ NTP pool —Å–µ—Ä–≤–µ—Ä–µ
- –ù–µ –º–µ—ö–∞ —Å–∏—Å—Ç–µ–º—Å–∫–æ –≤—Ä–µ–º–µ (—Å–∞–º–æ –∫–∞–ª–∫—É–ª–∏—à–µ offset)

## Future improvements

–ü–ª–∞–Ω–∏—Ä–∞–Ω–µ —É–Ω–∞–ø—Ä–µ—í–µ—ö–∞:
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞–±–∏–ª–Ω–∏ NTP —Å–µ—Ä–≤–µ—Ä–∏ (via settings)
- [ ] UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–µ
- [ ] –ì—Ä–∞—Ñ–∏–∫–æ–Ω –æ—Ñ—Å–µ—Ç–∞ —Ç–æ–∫–æ–º –≤—Ä–µ–º–µ–Ω–∞
- [ ] –ü–æ–¥—Ä—à–∫–∞ –∑–∞ –ª–æ–∫–∞–ª–Ω–µ NTP —Å–µ—Ä–≤–µ—Ä–µ
- [ ] Fallback –Ω–∞ HTTP time APIs (–∑–∞ restricted networks)

## –†–µ—Ñ–µ—Ä–µ–Ω—Ü–µ

- [RFC 5905 - Network Time Protocol Version 4](https://tools.ietf.org/html/rfc5905)
- [NTP Pool Project](https://www.ntppool.org/)
- [Time Synchronization Accuracy](https://en.wikipedia.org/wiki/Network_Time_Protocol#Clock_synchronization_algorithm)
